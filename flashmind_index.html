<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FlashMind – Chatbot UI (Black & Lime)</title>
    <style>
        /* Flashcard-specific styles */
        .flashcard-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
            width: 100%;
        }
        .flashcard {
            background: transparent;
            width: 100%;
            height: 180px;
            perspective: 1000px;
            cursor: pointer;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Changed to a neutral shadow */
            word-wrap: break-word;
            text-align: center;
        }
        .card-front {
            background: #1e1e1e;
            color: #d1ff4c;
        }
        .card-back {
            background: #121212;
            color:white;
            transform: rotateY(180deg);
        }
        .back-btn {
            margin-top: 30px;
            background: #d1ff4c;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        .back-btn:hover {
            background: #b3e63c;
        }
        /* General UI styles */
        :root {
            --bg: #000000; --panel: #0b0b0b; --muted: #1a1a1a; --muted-2: #121212;
            --line: #1f1f1f; --text: #eaeaea; --sub: #b3b3b3; --lime: #b6ff2b;
            --lime-strong: #a2ff00; --shadow: 0 8px 28px rgba(0, 0, 0, .6); --radius: 16px;
        }
        [data-theme="light"] {
            --bg: #f5f5f5; /* Softer white */
            --panel: #eeeeee; /* Slightly darker panel */
            --muted: #e0e0e0; /* Less bright muted */
            --muted-2: #d6d6d6; /* Even less bright muted-2 */
            --line: #cccccc; /* Adjusted line color */
            --text: #333333; /* Darker text for contrast */
            --sub: #666666; /* Darker sub text */
            --lime: #8bd600;
            --lime-strong: #7ac300;
            --shadow: 0 8px 28px rgba(0, 0, 0, .08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0 }
        html, body { height: 100% }
        body {
            background: var(--bg); color: var(--text);
            font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            display: flex; flex-direction: column;
        }
        .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0, 0, 0, 0) }
        button { font: inherit; cursor: pointer; background: none; border: none; color: inherit }
        header { position: sticky; top: 0; z-index: 20; backdrop-filter: saturate(120%) blur(4px);
            background: linear-gradient(180deg, rgba(0, 0, 0, .9), rgba(0, 0, 0, .75)); border-bottom: 1px solid var(--line) }
        [data-theme="light"] header {
            background: linear-gradient(180deg, rgba(245, 245, 245, .9), rgba(245, 245, 245, .75)); /* Use new light bg */
        }
        .wrap { max-width: 1400px; margin: 0 auto; padding: 16px; display: flex; align-items: center; gap: 12px }
        .brand { display: flex; align-items: center; gap: 14px }
        .logo { width: 44px; height: 44px; border-radius: 12px;
            background: radial-gradient(60% 60% at 40% 30%, var(--lime) 0%, #7aff00 30%, #2a2a2a 62%, #000 100%);
            box-shadow: 0 0 24px rgba(166, 255, 0, .35) inset, 0 0 32px rgba(166, 255, 0, .2) }
        .title { font-weight: 700; letter-spacing: .4px }
        .subtitle { font-size: 12px; color: var(--sub) }
        .grid { display: grid; gap: 16px; grid-template-columns: 280px 1fr; align-items: start;
            padding: 16px; max-width: 1400px; width: 100%; margin: 0 auto; flex: 1 }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; padding: 8px; gap: 8px } }
        .features { background: var(--panel); border: 1px solid var(--line); border-radius: var(--radius);
            box-shadow: var(--shadow); position: sticky; top: 86px; padding: 14px }
        .features h3 { margin: 6px 8px 10px; font-size: 13px; color: var(--sub); font-weight: 600; text-transform: uppercase; letter-spacing: .8px }
        .btns { display: grid; gap: 10px }
        .btn { padding: 12px 14px; border-radius: 12px; border: 1px solid #2a2a2a;
            background: linear-gradient(180deg, var(--muted), var(--muted-2));
            color: var(--text); text-align: left; cursor: pointer; transition: .16s }
        .btn:hover { transform: translateY(-1px); border-color: #3a3a3a }
        .btn .name { font-weight: 700; color: var(--lime) }
        .canvas { display: flex; flex-direction: column; gap: 16px; width: 100% }
        .hero { background: var(--panel); border: 1px solid var(--line); border-radius: var(--radius);
            padding: 16px; box-shadow: var(--shadow) }
        .chat { 
            background: var(--panel); 
            border: 1px solid var(--line); 
            border-radius: var(--radius);
            display: flex; 
            flex-direction: column; 
            box-shadow: var(--shadow); 
            height: 85vh; /* Sets a fixed height */
            flex: none; /* Prevents it from growing */
        }
        .stream { 
            flex: 1; /* Allows this part to grow and fill available space */
            padding: 18px; 
            overflow-y: auto; /* Adds a scrollbar when content overflows */
            scroll-behavior: smooth; 
        }
        .msg { display: flex; gap: 10px; margin: 10px 0 }
        .msg.user { justify-content: flex-end }
        .bubble { max-width: min(75%, 800px); padding: 12px 14px; border-radius: 14px; border: 1px solid #222;
            background: linear-gradient(180deg, #0f0f0f, #0a0a0a) }
        [data-theme="light"] .bubble { background: linear-gradient(180deg, var(--panel), var(--muted-2)); border-color: var(--line) }
        .msg.user .bubble { background: linear-gradient(180deg, #111, #0b0b0b); border-color: #2f2f2f;
            box-shadow: 0 0 0 1px rgba(182, 255, 43, .2) inset }
        [data-theme="light"] .msg.user .bubble { background: linear-gradient(180deg, var(--muted), var(--line)); border-color: var(--line);
            box-shadow: 0 0 0 1px rgba(139, 214, 0, .2) inset }
        .msg.user .bubble .text { color: var(--lime) }
        [data-theme="light"] .msg.user .bubble .text { color: var(--lime) }
        .from { font-size: 11px; color: var(--sub); margin-bottom: 4px }
        .text { white-space: pre-wrap }
        .attachments { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap }
        .thumb { width: 144px; height: 96px; object-fit: cover; border-radius: 10px; border: 1px solid #2a2a2a }
        [data-theme="light"] .thumb { border-color: var(--line); }
        .composer { display: flex; align-items: flex-end; gap: 10px; padding: 12px; border-top: 1px solid var(--line);
            background: linear-gradient(180deg, #0a0a0a, #070707);
            border-bottom-left-radius: var(--radius); border-bottom-right-radius: var(--radius) }
        [data-theme="light"] .composer { background: linear-gradient(180deg, var(--muted), var(--muted-2)) }
        .icon-btn { width: 42px; height: 42px; border-radius: 10px; border: 1px solid var(--line); background: var(--muted);
            display: grid; place-items: center; transition: .14s }
        .icon-btn svg { width: 20px; height: 20px; fill: var(--lime) }
        .input-wrap { flex: 1; position: relative; border: 1px solid #262626; background: #0e0e0e;
            border-radius: 14px; padding: 10px 48px 10px 12px }
        [data-theme="light"] .input-wrap { background: var(--bg); border-color: var(--line) }
        .input { width: 100%; background: transparent; color: var(--text); border: none; outline: none; resize: none; max-height: 120px }
        .chips { position: absolute; left: 10px; bottom: 44px; display: flex; gap: 8px; flex-wrap: wrap }
        .chip { position: relative }
        .chip img { width: 70px; height: 70px; border-radius: 10px; border: 1px solid #2a2a2a; object-fit: cover }
        [data-theme="light"] .chip img { border-color: var(--line) }
        .chip button { position: absolute; top: -8px; right: -8px; width: 22px; height: 22px; border-radius: 50%;
            border: 1px solid #2a2a2a; background: #0d0d0d; color: #fff; cursor: pointer; font-size: 12px }
        [data-theme="light"] .chip button { background: var(--bg); color: var(--text); border-color: var(--line); }
        .send { width: 46px; height: 42px; border-radius: 12px;
            background: radial-gradient(120% 120% at 30% 10%, var(--lime-strong), #6df400 45%, #263d00 110%);
            border: none; color: #000; font-weight: 700; cursor: pointer; box-shadow: 0 8px 30px rgba(166, 255, 0, .18);
            display: grid; place-items: center; transition: .12s }
        .send:hover { transform: translateY(-1px) }
        .finished-btn-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .finished-btn {
            padding: 12px 30px;
            border-radius: 12px;
            background: linear-gradient(180deg, var(--lime), var(--lime-strong));
            color: #000;
            font-weight: 700;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(182, 255, 43, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .finished-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(182, 255, 43, 0.6);
        }
        /* New styles for the quiz UI */
        .quiz-container {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 900px;
            margin: 20px auto;
        }
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--line);
            padding-bottom: 10px;
        }
        .quiz-header h2 {
            color: var(--lime);
        }
        .score-display {
            font-size: 1.2em;
            font-weight: bold;
        }
        .quiz-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .question-card {
            background: var(--muted-2);
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .question-card p {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .quiz-input-field {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
            color: #fff;
            margin-top: 10px;
        }
        .quiz-input-field.correct {
            border-color: #5cb85c;
            background: #3c6e3c;
        }
        .quiz-input-field.incorrect {
            border-color: #d9534f;
            background: #8b3a3a;
        }
        .explanation {
            margin-top: 10px;
            padding-left: 10px;
            border-left: 3px solid var(--lime);
            font-style: italic;
            color: var(--sub);
            display: none;
        }
        .quiz-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .submit-btn, .retake-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        .submit-btn {
            background: var(--lime);
            color: #000;
        }
        .retake-btn, .back-to-chat-btn {
            background: #333;
            color: var(--text);
        }
        .detail-btn {
            margin-top: 10px;
            align-self: flex-start;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--line);
            background: linear-gradient(180deg, var(--muted), var(--muted-2));
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .detail-btn:hover { transform: translateY(-1px); border-color: #3a3a3a; }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .visualization-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 400px;
        }
        .visualization-box img {
            max-width: 95%;
            height: auto;
            border: 1px solid #333;
            border-radius: 10px;
            background: #fff; /* White background for diagrams */
            padding: 10px;
            margin-bottom: 20px;
        }
        .back-to-chat-visual-btn {
            padding: 12px 24px;
            border-radius: 8px;
            background: #333;
            color: var(--text);
            font-weight: bold;
            cursor: pointer;
        }
        .back-to-chat-visual-btn:hover {
            background: #555;
        }
        /* New styles for multiple-choice quiz buttons */
        .quiz-option-btn {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 8px;
            border: 1px solid #333;
            background: #2a2a2a;
            color: #fff;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }
        .quiz-option-btn:hover {
            background: #444;
        }
        .quiz-option-btn.correct {
            background: #5cb85c;
            border-color: #5cb85c;
            color: white;
            font-weight: bold;
        }
        .quiz-option-btn.incorrect {
            background: #d9534f;
            border-color: #d9534f;
            color: white;
        }
        /* Light theme card and button styles */
        [data-theme="light"] .card-front {
            background: var(--muted);
            color: var(--text);
        }
        [data-theme="light"] .card-back {
            background: var(--panel);
            color: var(--text);
        }
        [data-theme="light"] .back-btn {
            background: var(--lime);
            color: #000;
        }
        [data-theme="light"] .back-btn:hover {
            background: var(--lime-strong);
        }
        [data-theme="light"] .question-card {
            background: var(--muted);
        }
        [data-theme="light"] .quiz-input-field {
            background: var(--bg);
            border-color: var(--line);
            color: var(--text);
        }
        [data-theme="light"] .quiz-option-btn {
            background: var(--muted-2);
            color: var(--text);
            border-color: var(--line);
        }
        [data-theme="light"] .quiz-option-btn:hover {
            background: var(--muted);
        }
        [data-theme="light"] .retake-btn,
        [data-theme="light"] .back-to-chat-btn {
            background: var(--muted);
        }
        [data-theme="light"] .back-to-chat-visual-btn {
            background: var(--muted);
        }

        /* Quiz Results Page */
        .quiz-results-container {
            display: none;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .quiz-results-container h2,
        .quiz-results-container h3 {
            color: var(--lime);
            text-align: center;
        }

        .score-summary {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
        }

        .review-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .wrong-question-card {
            background: var(--muted-2);
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 15px;
        }

        .wrong-question-card p {
            font-weight: bold;
        }

        .wrong-question-card .explanation,
        .wrong-question-card .topics {
            margin-top: 10px;
            font-style: italic;
        }

        .wrong-question-card .topics {
            margin-top: 5px;
            font-size: 0.9em;
        }
        
        .topics ul {
            list-style: disc;
            padding-left: 20px;
        }
        
        .theme-toggle {
            margin-left: auto;
            background: none;
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 8px 16px;
            color: var(--text);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .theme-toggle:hover {
            background-color: var(--muted);
        }
        .theme-toggle:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <header>
        <div class="wrap">
            <div class="brand">
                <div class="logo"></div>
                <div>
                    <div class="title">FLASHMIND</div>
                    <div class="subtitle">Learn smart, flash fast — Flashcards with brainpower</div>
                </div>
            </div>
            <button id="themeToggleBtn" class="theme-toggle">Switch to Light Theme</button>
        </div>
    </header>
    <main class="grid">
        <aside class="features">
            <h3>Quick Actions</h3>
            <div class="btns">
                <button class="btn" data-action="summarize"><span class="name">Summarize Text</span></button>
                <button class="btn" data-action="quiz"><span class="name">Generate Quiz</span></button>
                <button class="btn" data-action="flashcards"><span class="name">Flashcards</span></button>
                <button class="btn" data-action="dictionary"><span class="name">Dictionary</span></button>
                <button class="btn" data-action="visualize"><span class="name">Visualize Content</span></button>
            </div>
        </aside>
        <section class="canvas">
            <div id="visualization" class="hero visualization-box" style="display:none;"></div>
            <div id="chatContainer" class="chat">
                <div id="stream" class="stream"></div>
                <div class="composer">
                    <input type="file" id="fileInput" accept="image/*,.pdf" style="display:none;" />
                    <button id="pick" class="icon-btn" title="Upload file" aria-label="Upload file">
                        <svg viewBox="0 0 24 24"><path d="M20 5h-2.6l-1.1-1.7A2 2 0 0 0 14.7 2H9.3a2 2 0 0 0-1.6.8L6.6 5H4a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm-8 13a5 5 0 1 1 0-10 5 5 0 0 1 0 10Zm0-2.2a2.8 2.8 0 1 0 0-5.6 2.8 2.8 0 0 0 0 5.6Z"/></svg>
                    </button>
                    <div class="input-wrap">
                        <div id="chips" class="chips"></div>
                        <textarea id="input" class="input" rows="1" placeholder="Ask anything…"></textarea>
                    </div>
                    <button id="send" class="send">➤</button>
                </div>
            </div>
            <div id="flashcardGrid" class="flashcard-grid-container" style="display:none;"></div>
            <div id="finishedLearningContainer" class="finished-btn-container" style="display:none;">
                <button id="finishedLearningBtn" class="finished-btn">Finished Learning</button>
            </div>
            <div id="quizContainer" class="quiz-container" style="display:none;">
                <div id="quizHeader" class="quiz-header">
                    <h2>Quiz</h2>
                    <div id="scoreDisplay" class="score-display">Score: 0/0</div>
                </div>
                <div id="quizContent" class="quiz-content"></div>
                <div id="quizFooter" class="quiz-footer">
                    <button id="submitQuizBtn" class="submit-btn" style="display:none;">Submit Quiz</button>
                    <button id="retakeQuizBtn" class="retake-btn" style="display:none;">Retake Quiz</button>
                    <button id="backToChatBtn" class="retake-btn" style="display:none;">Back to Chat</button>
                </div>
            </div>
            <div id="quizResultsContainer" class="quiz-results-container">
                <h2 id="finalScore"></h2>
                <div id="reviewSection" class="review-section"></div>
                <button id="resultsBackToChatBtn" class="retake-btn">Back to Chat</button>
            </div>
        </section>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const $ = (sel, root = document) => root.querySelector(sel);
            const $$ = (sel, root = document) => root.querySelectorAll(sel);
            const pickBtn = $('#pick'), fileInput = $('#fileInput'), stream = $('#stream');
            const input = $('#input'), sendBtn = $('#send'), chipsContainer = $('#chips');
            const chatContainer = $('#chatContainer');
            const flashcardGrid = $('#flashcardGrid');
            const finishedLearningContainer = $('#finishedLearningContainer');
            const finishedLearningBtn = $('#finishedLearningBtn');
            const quizContainer = $('#quizContainer');
            const quizContent = $('#quizContent');
            const scoreDisplay = $('#scoreDisplay');
            const backToChatBtn = $('#backToChatBtn');
            const visualizationDiv = $('#visualization');
            const quizResultsContainer = $('#quizResultsContainer');
            const finalScoreEl = $('#finalScore');
            const reviewSectionEl = $('#reviewSection');
            const resultsBackToChatBtn = $('#resultsBackToChatBtn');
            const themeToggleBtn = $('#themeToggleBtn');
            const html = $('html');

            let currentQuizData = null;
            let uploadedFile = null;
            let quizScore = 0;
            let answeredQuestions = 0;

            // Theme toggle functionality
            themeToggleBtn.addEventListener('click', () => {
                const currentTheme = html.getAttribute('data-theme');
                if (currentTheme === 'dark') {
                    html.setAttribute('data-theme', 'light');
                    themeToggleBtn.textContent = 'Switch to Dark Theme';
                } else {
                    html.setAttribute('data-theme', 'dark');
                    themeToggleBtn.textContent = 'Switch to Light Theme';
                }
            });

            pickBtn.addEventListener('click', () => {
                fileInput.click();
            });
            fileInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (file) { uploadedFile = file; displayFilePreview(file); }
            });

            function displayFilePreview(file) {
                chipsContainer.innerHTML = '';
                const chip = document.createElement('div');
                chip.className = 'chip';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.alt = file.name;
                const remove = document.createElement('button');
                remove.textContent = 'x';
                remove.title = 'Remove file';
                remove.onclick = () => { uploadedFile = null; chipsContainer.innerHTML = ''; fileInput.value = ''; };
                chip.append(img, remove);
                chipsContainer.appendChild(chip);
            }

            const formatTime = (d = new Date()) => d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            function renderMessage(role, text, imageUrl = null) {
                const msg = document.createElement('div');
                msg.className = `msg ${role === 'user' ? 'user' : ''}`;
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                const meta = document.createElement('div');
                meta.className = 'from';
                meta.textContent = `${role === 'user' ? 'You' : 'FlashMind'} · ${formatTime()}`;
                const body = document.createElement('div');
                body.className = 'text';
                body.textContent = text;
                bubble.append(meta, body);
                if (imageUrl) {
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.className = 'thumb';
                    const att = document.createElement('div');
                    att.className = 'attachments';
                    att.appendChild(img);
                    bubble.appendChild(att);
                }
                msg.appendChild(bubble);
                stream.appendChild(msg);
                stream.scrollTop = stream.scrollHeight;
                return msg;
            }

            async function send() {
                const text = input.value.trim();
                if (!text && !uploadedFile) return;
                
                // The hardcoded response logic for greetings has been removed from here.
                // The Python backend now handles all conversational logic.

                const msgImg = uploadedFile ? URL.createObjectURL(uploadedFile) : null;
                const userMsgEl = renderMessage('user', text, msgImg);
                const formData = new FormData();
                formData.append('message', text);
                if (uploadedFile) {
                    formData.append('file', uploadedFile);
                    uploadedFile = null;
                    chipsContainer.innerHTML = '';
                    fileInput.value = '';
                }
                input.value = '';
                sendBtn.disabled = true;
                const typing = document.createElement('div');
                typing.className = 'msg';
                typing.innerHTML = `<div class="bubble"><div class="from">FlashMind · ${formatTime()}</div><div class="text">…</div></div>`;
                stream.appendChild(typing);
                stream.scrollTop = stream.scrollHeight;
                try {
                    const res = await fetch('/chat', { method: 'POST', body: formData });
                    if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text() || 'Request failed'}`);
                    const data = await res.json();
                    typing.remove();
                    const msgEl = renderMessage('assistant', data.reply || '(empty reply)');
                    if (data.is_problem) {
                        attachProblemButtons(msgEl);
                    } else if (data.detail) {
                        attachDetailButton(msgEl, text);
                    }
                } catch (err) {
                    typing.remove();
                    renderMessage('assistant', `⚠️ Error: ${err.message}`);
                } finally {
                    sendBtn.disabled = false;
                    input.focus();
                }
            }

            sendBtn.addEventListener('click', send);
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    send();
                }
            });

            async function handleProblemAction(action) {
                // Display the user's action in the chat
                renderMessage('user', `I chose to ${action.replace('_', ' ')}.`); 
                const typing = document.createElement('div');
                typing.className = 'msg';
                typing.innerHTML = `<div class="bubble"><div class="from">FlashMind · ${formatTime()}</div><div class="text">…</div></div>`;
                stream.appendChild(typing);
                stream.scrollTop = stream.scrollHeight;
                try {
                    const res = await fetch(`/${action}`, { method: 'POST' });
                    const data = await res.json();
                    typing.remove();
                    const msgEl = renderMessage('assistant', data.reply || data.solution_text || '(empty reply)');
                    if (data.is_hint) {
                        attachHintButtons(msgEl);
                    } else if (data.is_solution) {
                        attachSolutionExplanationButton(msgEl, data.solution_text);
                    }
                } catch (e) {
                    typing.remove();
                    renderMessage('assistant', `⚠️ Error: ${e.message}`);
                }
            }

            function attachProblemButtons(msgEl) {
                const bubble = msgEl.querySelector('.bubble');
                const btnContainer = document.createElement('div');
                btnContainer.className = 'action-buttons';
                const hintBtn = document.createElement('button');
                hintBtn.className = 'detail-btn';
                hintBtn.textContent = 'Get a Hint';
                hintBtn.addEventListener('click', () => handleProblemAction('get_hint'));
                btnContainer.appendChild(hintBtn);
                const solveBtn = document.createElement('button');
                solveBtn.className = 'detail-btn';
                solveBtn.textContent = 'Solve it';
                solveBtn.addEventListener('click', () => handleProblemAction('solve_problem'));
                btnContainer.appendChild(solveBtn);
                bubble.appendChild(btnContainer);
            }

            function attachHintButtons(msgEl) {
                const bubble = msgEl.querySelector('.bubble');
                const btnContainer = document.createElement('div');
                btnContainer.className = 'action-buttons';
                const nextHintBtn = document.createElement('button');
                nextHintBtn.className = 'detail-btn';
                nextHintBtn.textContent = 'Next Hint';
                nextHintBtn.addEventListener('click', () => handleProblemAction('get_hint'));
                btnContainer.appendChild(nextHintBtn);
                const cannotSolveBtn = document.createElement('button');
                cannotSolveBtn.className = 'detail-btn';
                cannotSolveBtn.textContent = 'Cannot Solve it';
                cannotSolveBtn.addEventListener('click', () => handleProblemAction('solve_problem'));
                btnContainer.appendChild(cannotSolveBtn);
                bubble.appendChild(btnContainer);
            }

            function attachSolutionExplanationButton(msgEl, solutionText) {
                const bubble = msgEl.querySelector('.bubble');
                const btn = document.createElement('button');
                btn.className = 'detail-btn';
                btn.textContent = 'Detailed explanation';
                btn.addEventListener('click', () => {
                    handleSolutionExplanation(solutionText);
                });
                bubble.appendChild(btn);
            }
            
            async function handleSolutionExplanation(solutionText) {
                const typing = document.createElement('div');
                typing.className = 'msg';
                typing.innerHTML = `<div class="bubble"><div class="from">FlashMind · ${formatTime()}</div><div class="text">Loading detailed explanation...</div></div>`;
                stream.appendChild(typing);
                stream.scrollTop = stream.scrollHeight;
                try {
                    const res = await fetch('/explain_solution', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ solution: solutionText })
                    });
                    const data = await res.json();
                    typing.remove();
                    renderMessage('assistant', data.reply || '(empty reply)');
                } catch (e) {
                    typing.remove();
                    renderMessage('assistant', `⚠️ Error: ${e.message}`);
                }
            }

            // Function to attach the detailed explanation button
            function attachDetailButton(msgEl, userMessage) {
                const bubble = msgEl.querySelector('.bubble');
                const btn = document.createElement('button');
                btn.className = 'detail-btn';
                btn.textContent = 'Detailed explanation';
                btn.addEventListener('click', () => {
                    handleDetailedExplanation(userMessage);
                });
                bubble.appendChild(btn);
            }

            // Function to handle the detailed explanation API call
            async function handleDetailedExplanation(userMessage) {
                const typing = document.createElement('div');
                typing.className = 'msg';
                typing.innerHTML = `<div class="bubble"><div class="from">FlashMind · ${formatTime()}</div><div class="text">Generating a detailed explanation...</div></div>`;
                stream.appendChild(typing);
                stream.scrollTop = stream.scrollHeight;
                try {
                    const res = await fetch('/explain_more', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMessage })
                    });
                    const data = await res.json();
                    typing.remove();
                    renderMessage('assistant', data.reply || '(empty reply)');
                } catch (e) {
                    typing.remove();
                    renderMessage('assistant', `⚠️ Error: ${e.message}`);
                }
            }

            function renderQuiz(quizData) {
                quizContent.innerHTML = '';
                quizScore = 0;
                answeredQuestions = 0;
                scoreDisplay.textContent = `Score: ${quizScore}/${quizData.length}`;

                quizData.forEach((q, index) => {
                    const questionLetters = ['A', 'B', 'C', 'D'];
                    const card = document.createElement('div');
                    card.className = 'question-card';
                    card.dataset.questionIndex = index;
                    const questionText = document.createElement('p');
                    questionText.textContent = `${index + 1}. ${q.question}`;
                    card.appendChild(questionText);
                    
                    q.options.forEach((option, optionIndex) => {
                        const optionBtn = document.createElement('button');
                        optionBtn.className = 'quiz-option-btn';
                        optionBtn.textContent = `${questionLetters[optionIndex]}. ${option}`;
                        optionBtn.dataset.option = questionLetters[optionIndex];
                        optionBtn.addEventListener('click', (e) => handleQuizOptionClick(e, q.correctAnswer));
                        card.appendChild(optionBtn);
                    });

                    const explanation = document.createElement('div');
                    explanation.className = 'explanation';
                    explanation.innerHTML = `<strong>Correct Answer:</strong> ${q.correctAnswer}. ${q.correctExplanation}`;
                    card.appendChild(explanation);
                    quizContent.appendChild(card);
                });
                
                $('#quizFooter').style.display = 'flex';
                $('#submitQuizBtn').style.display = 'none';
                $('#retakeQuizBtn').style.display = 'none';
                $('#backToChatBtn').style.display = 'block';
            }

            function handleQuizOptionClick(event, correctAnswer) {
                const clickedBtn = event.target;
                const parentCard = clickedBtn.closest('.question-card');
                const questionOptions = parentCard.querySelectorAll('.quiz-option-btn');
                
                questionOptions.forEach(btn => btn.disabled = true);
                
                const userChoice = clickedBtn.dataset.option;
                
                // First, find the correct answer button and apply the 'correct' class
                questionOptions.forEach(btn => {
                    if (btn.dataset.option === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });

                // Then, if the user's choice was incorrect, apply the 'incorrect' class to their button
                if (userChoice !== correctAnswer) {
                    clickedBtn.classList.add('incorrect');
                } else {
                    quizScore++;
                }

                parentCard.querySelector('.explanation').style.display = 'block';
                
                // Check if all questions are answered and update score
                answeredQuestions++;
                scoreDisplay.textContent = `Score: ${quizScore}/${currentQuizData.length}`;

                if (answeredQuestions === currentQuizData.length) {
                    displayQuizResults();
                }
            }
            
            function displayQuizResults() {
                quizContainer.style.display = 'none';
                quizResultsContainer.style.display = 'flex';
                finalScoreEl.textContent = `You scored ${quizScore} out of ${currentQuizData.length}!`;
                
                reviewSectionEl.innerHTML = '';
                let hasWrongAnswers = false;

                currentQuizData.forEach((q, index) => {
                    const questionCard = document.createElement('div');
                    const questionNumber = index + 1;
                    const questionText = q.question;
                    const correctExplanation = q.correctExplanation;
                    const topicsToFocusOn = q.topicsToFocusOn;
                    
                    const originalQuestionCard = $(`[data-question-index="${index}"]`, quizContent);
                    const userAnswerBtn = originalQuestionCard.querySelector('.quiz-option-btn.incorrect');

                    if (userAnswerBtn) {
                        hasWrongAnswers = true;
                        questionCard.className = 'wrong-question-card';
                        
                        questionCard.innerHTML = `
                            <p>Question ${questionNumber}: ${questionText}</p>
                            <div class="explanation">
                                <p><strong>Correct Answer:</strong> ${q.correctAnswer}. ${correctExplanation}</p>
                            </div>
                            <div class="topics">
                                <p><strong>Suggested topics to cover:</strong></p>
                                <ul>
                                    ${topicsToFocusOn.map(topic => `<li>${topic}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                        reviewSectionEl.appendChild(questionCard);
                    }
                });
                
                if (hasWrongAnswers) {
                    const reviewHeading = document.createElement('h3');
                    reviewHeading.textContent = "Review Your Answers";
                    reviewSectionEl.prepend(reviewHeading);
                } else {
                    const allCorrectMsg = document.createElement('h3');
                    allCorrectMsg.textContent = "Great job! You got all the questions right.";
                    reviewSectionEl.appendChild(allCorrectMsg);
                }
            }
            
            document.querySelectorAll(".btn").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const action = btn.dataset.action;
                    // Display the user's action in the chat
                    renderMessage("user", `Generate "${btn.querySelector(".name").textContent}"`);
                    
                    chatContainer.style.display = 'none';
                    flashcardGrid.style.display = 'none';
                    finishedLearningContainer.style.display = 'none';
                    quizContainer.style.display = 'none';
                    visualizationDiv.style.display = 'none';
                    quizResultsContainer.style.display = 'none';
                    
                    if (action === "visualize") {
                        const res = await fetch("/visualize", { method: "POST" });
                        const data = await res.json();
                        if (data.image_url) {
                            visualizationDiv.style.display = 'flex';
                            visualizationDiv.innerHTML = `<img src="${data.image_url}" alt="Diagram from content">
                                <button id="backToChatFromVisualBtn" class="back-to-chat-visual-btn">Back to Chat</button>`;
                            $('#backToChatFromVisualBtn').addEventListener('click', () => {
                                visualizationDiv.style.display = 'none';
                                chatContainer.style.display = 'flex';
                            });
                        } else {
                            chatContainer.style.display = 'flex';
                            renderMessage("assistant", data.reply || "⚠️ Failed to generate visualization.");
                        }
                    } else if (action === "summarize" || action === "dictionary") {
                        chatContainer.style.display = 'flex';
                        const res = await fetch(`/${action}`, { method: "POST" });
                        const data = await res.json();
                        const msgEl = renderMessage("assistant", data.reply);
                        if (data.detail) attachDetailButton(msgEl, "");
                    } else if (action === "flashcards") {
                        chatContainer.style.display = 'none';
                        flashcardGrid.style.display = 'grid';
                        finishedLearningContainer.style.display = 'flex';
                        const res = await fetch("/flashcards", { method: "POST" });
                        const data = await res.json();
                        flashcardGrid.innerHTML = "";
                        if (!data.cards || data.cards.length === 0) {
                            chatContainer.style.display = 'flex';
                            flashcardGrid.style.display = 'none';
                            finishedLearningContainer.style.display = 'none';
                            renderMessage("assistant", "⚠️ No flashcards available from the last file.");
                            return;
                        }
                        data.cards.forEach(card => {
                            const div = document.createElement("div");
                            div.className = "flashcard";
                            div.innerHTML = `
                                <div class="card-inner">
                                    <div class="card-front"><p>${card.q}</p></div>
                                    <div class="card-back"><p>${card.a}</p></div>
                                </div>`;
                            div.addEventListener("click", () => { div.classList.toggle("flipped"); });
                            flashcardGrid.appendChild(div);
                        });
                    } else if (action === "quiz") {
                        chatContainer.style.display = 'none';
                        quizContainer.style.display = 'flex';
                        const res = await fetch("/quiz", { method: "POST" });
                        const data = await res.json();
                        if (data.quiz) {
                            currentQuizData = data.quiz;
                            renderQuiz(currentQuizData);
                            $('#quizFooter').style.display = 'flex';
                            $('#backToChatBtn').style.display = 'block';
                            scoreDisplay.textContent = `Score: 0/${currentQuizData.length}`;
                        } else {
                            chatContainer.style.display = 'flex';
                            renderMessage('assistant', data.reply);
                        }
                    }
                });
            });

            backToChatBtn.addEventListener('click', () => {
                quizContainer.style.display = 'none';
                chatContainer.style.display = 'flex';
            });

            resultsBackToChatBtn.addEventListener('click', () => {
                // Display the score in the chat before switching back
                renderMessage('assistant', `Quiz finished! Your final score is ${quizScore} out of ${currentQuizData.length}.`);

                quizResultsContainer.style.display = 'none';
                chatContainer.style.display = 'flex';
            });

            finishedLearningBtn.addEventListener('click', () => {
                flashcardGrid.style.display = 'none';
                finishedLearningContainer.style.display = 'none';
                chatContainer.style.display = 'flex';
            });
        });
    </script>
</body>
</html>